apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: cd-argocd-objects
  labels:
    app.kubernetes.io/name: {{ .Chart.Name }}-argo-cd
    helm.sh/chart: {{ .Chart.Version | quote }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: ArgoCD
    app.kubernetes.io/part-of: {{ .Release.Name }}
    app.kubernetes.io/component: argo-cd
  finalizers:
  - resources-finalizer.argocd.argoproj.io
spec:
  destination:
    namespace: tools
    server: {{ .Values.spec.destination.server }}
  source:
    repoURL: 'https://argoproj.github.io/argo-helm'
    targetRevision: {{ .Values.argocdapps.targetRevision | quote }}
    chart: argocd-apps
    helm:
      values: |
        projects: 
        - name: svc-tools
          namespace: tools
          additionalLabels: {}
          additionalAnnotations: {}
          description: Tool Services, i.e. CD, CI, Git, etc.
          sourceRepos:
          - git@github.com:know-ops/infra-hq.git
          - https://argoproj.github.io/argo-helm
          destinations:
          - namespace: tools
            server: https://kubernetes.default.svc
          clusterResourceWhitelist:
          - group: '*'
            kind: '*'
          orphanedResources: {}
          roles: []

        - name: cd-argocd
          namespace: tools
          additionalLabels: {}
          additionalAnnotations: {}
          description: ArgoCD specific Objects
          sourceRepos:
          - https://argoproj.github.io/argo-helm
          destinations:
          - namespace: tools
            server: https://kubernetes.default.svc
          namespaceResourceWhitelist:
          - group: 'argoproj.io'
            kind: '*'
          orphanedResources: {}
          roles: []

        - name: svc-infra
          namespace: tools
          additionalLabels: {}
          additionalAnnotations: {}
          description: Infrastructure Services, i.e. cert-manager, etc.
          sourceRepos:
          - git@github.com:know-ops/infra-hq.git
          - https://charts.jetstack.io
          destinations:
          - namespace: tools
            server: https://kubernetes.default.svc
          - namespace: cert-manager
            server: https://kubernetes.default.svc
          clusterResourceWhitelist:
          - group: '*'
            kind: '*'
          orphanedResources: {}
          roles: []

        applications:
        - name: cd-apps
          project: svc-tools
          source:
            path: cd/apps
            repoURL: git@github.com:know-ops/infra-hq.git
            targetRevision: feature/initial_version
          destination:
            namespace: tools
            server: https://kubernetes.default.svc
          syncPolicy:
            automated:
              selfHeal: true
              prune: true

        - name: infra-apps
          project: svc-infra
          source:
            path: infra/apps
            repoURL: git@github.com:know-ops/infra-hq.git
            targetRevision: feature/initial_version
          destination:
            namespace: tools
            server: https://kubernetes.default.svc
          syncPolicy:
            automated:
              selfHeal: true
              prune: true

  project: cd-argocd
  syncPolicy:
    automated: 
      selfHeal: true
      prune: true
    syncOptions:
      - RespectIgnoreDifferences=true
      - PruneLast=true
  ignoreDifferences:
  - group: argoproj.io/v1alpha1
    kind: Application
    name: cd-apps
    namespace: tools
    jsonPointers:
    - /