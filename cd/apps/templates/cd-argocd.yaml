apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: cd-argocd
  labels:
    app.kubernetes.io/name: {{ .Chart.Name }}-argo-cd
    helm.sh/chart: {{ .Chart.Version | quote }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: ArgoCD
    app.kubernetes.io/part-of: {{ .Release.Name }}
    app.kubernetes.io/component: cert-manager
  finalizers:
  - resources-finalizer.argocd.argoproj.io
spec:
  destination:
    namespace: tools
    server: {{ .Values.spec.destination.server }}
  source:
    repoURL: 'https://argoproj.github.io/argo-helm'
    targetRevision: {{ .Values.argocd.targetRevision | quote }}
    chart: argo-cd
    helm:
      values: |
        fullnameOverride: cd-argocd
        installCRDs: false

        server:
          extraArgs:
          - --rootpath
          - /tools/cd/argocd
          - --basehref
          - /tools/cd/argocd

          ingress:
            enabled: true

            annotations:
              kubernetes.io/ingress.class: nginx
              kubernetes.io/tls-acme: "true"
              nginx.ingress.kubernetes.io/ssl-passthrough: "true"
              nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"

            hosts:
            - hq.know-ops.com

            tls:
            - hosts:
              - hq.know-ops.com
              secretName: argocd-secret

            paths:
            - /tools/cd/argocd

            https: true

          certificate:
            enabled: true
            domain: hq.know-ops.com
            issuer:
              kind: ClusterIssuer
              name: letsencrypt-staging

          config:
            url: https://hq.know-ops.com/tools/cd/argocd

            admin.enabled: "false"

            users.anonymous.enabled: "true"

            dex.config: |
              connectors:
                # GitHub example
                - type: github
                  id: github
                  name: GitHub
                  config:
                    clientID: 37f595427919977080dd
                    clientSecret: $dex.github.clientSecret
                    orgs:
                    - name: know-ops

            repositories: |
              - url: git@github.com:know-ops/infra-hq.git
                sshPrivateKeySecret:
                  name: argocd-repository-credentials
                  key: infra-hq
                name: infra-hq
              - type: helm
                url: https://kubernetes-charts.storage.googleapis.com
                name: stable
              - type: helm
                url: https://argoproj.github.io/argo-helm
                name: argo
              - type: helm
                url: https://codecentric.github.io/helm-charts
                name: codecentric
              - type: helm
                url: https://charts.jetstack.io
                name: jetstack

          rbacConfig:
            policy.default: 'role:readonly'
            policy.csv: |
              g, know-ops:admin, role:admin
            scopes: '[groups]'

          additionalProjects: 
          - name: tools-cd
            namespace: tools
            additionalLabels: {}
            additionalAnnotations: {}
            description: CD Tools
            sourceRepos:
            - git@github.com:know-ops/infra-hq.git
            - https://argoproj.github.io/argo-helm
            destinations:
            - namespace: tools
              server: https://kubernetes.default.svc
            clusterResourceWhitelist:
            - group: '*'
              kind: '*'
            orphanedResources: {}
            roles: []

          - name: tools-ci
            namespace: tools
            additionalLabels: {}
            additionalAnnotations: {}
            description: CI Tools
            sourceRepos:
            - git@github.com:know-ops/infra-hq.git
            destinations:
            - namespace: tools
              server: https://kubernetes.default.svc
            clusterResourceWhitelist:
            - group: '*'
              kind: '*'
            orphanedResources: {}
            roles: []

          - name: tools-infra
            namespace: tools
            additionalLabels: {}
            additionalAnnotations: {}
            description: Infrastructure Tools
            sourceRepos:
            - git@github.com:know-ops/infra-hq.git
            - https://charts.jetstack.io
            destinations:
            - namespace: tools
              server: https://kubernetes.default.svc
            - namespace: cert-manager
              server: https://kubernetes.default.svc
            clusterResourceWhitelist:
            - group: '*'
              kind: '*'
            orphanedResources: {}
            roles: []

          additionalApplications:
          - name: cd-apps
            project: tools-cd
            source:
              path: cd/apps
              repoURL: git@github.com:know-ops/infra-hq.git
              targetRevision: feature/initial_version
            destination:
              namespace: tools
              server: https://kubernetes.default.svc
            syncPolicy:
              automated:
                selfHeal: true

          - name: infra-apps
            project: tools-infra
            source:
              path: infra/apps
              repoURL: git@github.com:know-ops/infra-hq.git
              targetRevision: feature/initial_version
            destination:
              namespace: tools
              server: https://kubernetes.default.svc
            syncPolicy:
              automated:
                selfHeal: true

        configs:
          secret:
            # Enable only on initial deployment
            createSecret: false
  project: {{ .Values.spec.project }}
  syncPolicy:
    automated: 
      selfHeal: true
  ignoreDifferences:
  - group: argoproj.io/v1alpha1
    kind: Application
    name: cd-apps
    namespace: tools
    jsonPointers:
    - /